#+TITLE: Subject 1: CO2 concentration in the atmosphere since 1958
#+AUTHOR: VU Anh Tuan
#+DATE: 2026-01-14
#+OPTIONS: toc:t num:t

* Introduction

In 1958, Charles David Keeling began continuous measurement of atmospheric CO2 
at Mauna Loa Observatory, Hawaii. This location was chosen for its remote, 
high-altitude position (3,397m), far from local pollution sources and in the 
path of well-mixed Pacific trade winds. The resulting "Keeling Curve" has 
become one of climate science's most important datasets, showing both seasonal 
biological cycles and the long-term impact of human fossil fuel emissions.

This analysis examines 67 years of measurements (1958-2025) to:
1. Visualize the superposition of seasonal oscillation and systematic trend
2. Characterize the seasonal cycle and quantify the long-term increase
3. Develop a simple model for extrapolation and validation

* Data Preparation

** Loading the Dataset

#+BEGIN_SRC R :session *R* :exports both :results output
library(ggplot2)  
library(dplyr)    
library(lubridate) 
library(scales)   

# Read the CO2 data file
co2_data <- read.csv("data/monthly_in_situ_co2_mlo.csv", 
                     skip = 64,
                     col.names = c("Year", "Month", "Excel_Date", "Decimal_Date",
                                   "CO2", "CO2_Seasonally_Adjusted", "Fit", 
                                   "Fit_Seasonally_Adjusted", "CO2_Filled", 
                                   "CO2_Filled_Seasonally_Adjusted", "Station"))

# Filter missing values (-99.99)
co2_data <- co2_data %>%
  filter(CO2 > 0)

# Create date column (15th of each month)
co2_data$Date <- as.Date(paste(co2_data$Year, co2_data$Month, 15, sep = "-"))

# Display basic information
cat("=== DATASET OVERVIEW ===\n")
cat(sprintf("Time period: %s to %s\n", 
            format(min(co2_data$Date), "%B %Y"), 
            format(max(co2_data$Date), "%B %Y")))
cat(sprintf("Total observations: %d\n", nrow(co2_data)))
cat(sprintf("Duration: %.1f years\n", 
            as.numeric(difftime(max(co2_data$Date), min(co2_data$Date), units = "days")) / 365.25))
cat(sprintf("CO2 range: %.2f - %.2f ppm\n", min(co2_data$CO2), max(co2_data$CO2)))
#+END_SRC

#+RESULTS:
#+begin_example

Attaching package: ‘dplyr’

The following objects are masked from ‘package:stats’:

    filter, lag

The following objects are masked from ‘package:base’:

    intersect, setdiff, setequal, union

Attaching package: ‘lubridate’

The following objects are masked from ‘package:base’:

    date, intersect, setdiff, union
=== DATASET OVERVIEW ===
Time period: March 1958 to November 2025
Total observations: 808
Duration: 67.7 years
CO2 range: 313.21 - 430.20 ppm
#+end_example

** Data Summary

#+BEGIN_SRC R :session *R* :exports both :results output
# Calculate overall change
first_co2 <- co2_data$CO2[1]
last_co2 <- co2_data$CO2[nrow(co2_data)]
total_change <- last_co2 - first_co2
percent_change <- (total_change / first_co2) * 100

cat("\n=== OVERALL CHANGE ===\n")
cat(sprintf("From %.2f ppm (1958) to %.2f ppm (2025)\n", first_co2, last_co2))
cat(sprintf("Increase: %.2f ppm (%.1f%%)\n", total_change, percent_change))
#+END_SRC

#+RESULTS:
: 
: === OVERALL CHANGE ===
: From 315.71 ppm (1958) to 425.92 ppm (2025)
: Increase: 110.21 ppm (34.9%)

* Visualizing the Long-Term Trend

** The Complete Keeling Curve

#+BEGIN_SRC R :session *R* :results output graphics file :file images/co2_longterm_trend.png :width 10 :height 6 :units in :res 150 :exports both
ggplot(co2_data, aes(x = Date, y = CO2)) +
  geom_line(color = "darkblue", linewidth = 0.5, alpha = 0.8) +
  geom_smooth(method = "lm", color = "red", linewidth = 1.2, 
              se = TRUE, linetype = "dashed", alpha = 0.2) +
  labs(title = "The Keeling Curve: Atmospheric CO2 at Mauna Loa (1958-2025)",
       subtitle = "Monthly measurements with linear trend and 95% confidence interval",
       x = "Year",
       y = "CO2 Concentration (ppm)",
       caption = "Data: Scripps CO2 Program") +
  theme_minimal(base_size = 12) +
  theme(plot.title = element_text(face = "bold", size = 14),
        panel.grid.minor = element_blank())
#+END_SRC

#+RESULTS:
[[file:images/co2_longterm_trend.png]]

*Key observations*: Persistent upward trend with regular seasonal oscillations. The shaded area shows 95% confidence interval for the trend.

** Evolution Across Decades

#+BEGIN_SRC R :session *R* :results output graphics file :file images/co2_by_decade.png :width 10 :height 7 :units in :res 150 :exports both
co2_data$Decade <- paste0(floor(co2_data$Year / 10) * 10, "s")

ggplot(co2_data, aes(x = Month, y = CO2, group = Year, color = Year)) +
  geom_line(alpha = 0.6, linewidth = 0.5) +
  facet_wrap(~Decade, scales = "free_y", ncol = 2) +
  scale_color_viridis_c(option = "plasma") +
  scale_x_continuous(breaks = c(1, 4, 7, 10), labels = c("Jan", "Apr", "Jul", "Oct")) +
  labs(title = "Seasonal CO2 Cycles by Decade",
       x = "Month", y = "CO2 (ppm)", color = "Year") +
  theme_minimal() +
  theme(legend.position = "right")
#+END_SRC

#+RESULTS:
[[file:images/co2_by_decade.png]]

* Statistical Analysis: Linear Regression

** Fitting the Trend

#+BEGIN_SRC R :session *R* :exports both :results output
co2_data$Time_Numeric <- as.numeric(co2_data$Date - min(co2_data$Date)) / 365.25
model_full <- lm(CO2 ~ Time_Numeric, data = co2_data)

cat("\n=== LINEAR REGRESSION ===\n")
print(summary(model_full))

# Extract parameters
slope <- coef(model_full)[2]
intercept <- coef(model_full)[1]
r_squared <- summary(model_full)$r.squared

cat("\n=== KEY RESULTS ===\n")
cat(sprintf("Slope: %.3f ppm/year\n", slope))
cat(sprintf("R²: %.4f (%.1f%% variance explained)\n", r_squared, r_squared*100))
#+END_SRC

#+RESULTS:
#+begin_example

=== LINEAR REGRESSION ===

Call:
lm(formula = CO2 ~ Time_Numeric, data = co2_data)

Residuals:
    Min      1Q  Median      3Q     Max 
-9.6682 -3.8154 -0.9457  3.4167 14.6134 

Coefficients:
              Estimate Std. Error t value Pr(>|t|)    
(Intercept)  3.043e+02  3.659e-01   831.6   <2e-16 ***
Time_Numeric 1.657e+00  9.334e-03   177.5   <2e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 5.167 on 806 degrees of freedom
Multiple R-squared:  0.9751,	Adjusted R-squared:  0.975 
F-statistic: 3.152e+04 on 1 and 806 DF,  p-value: < 2.2e-16

=== KEY RESULTS ===
Slope: 1.657 ppm/year
R²: 0.9751 (97.5% variance explained)
#+end_example

** Confidence Interval for Slope

#+BEGIN_SRC R :session *R* :exports both :results output
ci_slope <- confint(model_full, "Time_Numeric", level = 0.95)

cat("\n=== 95% CONFIDENCE INTERVAL ===\n")
cat(sprintf("Slope: %.3f ppm/year\n", slope))
cat(sprintf("95%% CI: [%.3f, %.3f] ppm/year\n", ci_slope[1], ci_slope[2]))
cat("\nInterpretation: We are 95% confident the true annual\n")
cat("CO2 increase rate lies within this interval.\n")
#+END_SRC

#+RESULTS:
: 
: === 95% CONFIDENCE INTERVAL ===
: Slope: 1.657 ppm/year
: 95% CI: [1.639, 1.675] ppm/year
: 
: Interpretation: We are 95% confident the true annual
: CO2 increase rate lies within this interval.

* Model Diagnostics

#+BEGIN_SRC R :session *R* :results output graphics file :file images/model_diagnostics.png :width 12 :height 8 :units in :res 150 :exports both
co2_data$Residuals <- residuals(model_full)
co2_data$Fitted <- fitted(model_full)

par(mfrow = c(2, 2), mar = c(4, 4, 2, 1))

# 1. Residuals vs Time
plot(co2_data$Date, co2_data$Residuals, type = "l", col = "darkblue",
     main = "Residuals Over Time", xlab = "Year", ylab = "Residuals (ppm)")
abline(h = 0, col = "red", lty = 2, lwd = 2)

# 2. Q-Q Plot
qqnorm(co2_data$Residuals, pch = 16, col = alpha("darkgreen", 0.5))
qqline(co2_data$Residuals, col = "red", lwd = 2)

# 3. ACF
acf(co2_data$Residuals, main = "Autocorrelation", lag.max = 36, col = "purple", lwd = 2)

# 4. Histogram
hist(co2_data$Residuals, breaks = 40, col = "lightblue", border = "white",
     main = "Distribution of Residuals", xlab = "Residuals (ppm)")

par(mfrow = c(1, 1))
#+END_SRC

#+RESULTS:
[[file:images/model_diagnostics.png]]

#+BEGIN_SRC R :session *R* :exports both :results output
cat("\n=== DIAGNOSTIC SUMMARY ===\n")
cat("• Residuals show clear seasonal pattern (expected - not modeled)\n")
cat("• ACF confirms strong autocorrelation at 12-month lag\n")
cat("• Residuals approximately normal (Q-Q plot)\n")
cat("• Trend estimate valid despite autocorrelation\n")
#+END_SRC

#+RESULTS:
: 
: === DIAGNOSTIC SUMMARY ===
: • Residuals show clear seasonal pattern (expected - not modeled)
: • ACF confirms strong autocorrelation at 12-month lag
: • Residuals approximately normal (Q-Q plot)
: • Trend estimate valid despite autocorrelation

* Understanding the Seasonal Cycle

#+BEGIN_SRC R :session *R* :results output graphics file :file images/co2_seasonal_pattern.png :width 10 :height 6 :units in :res 150 :exports both
monthly_pattern <- co2_data %>%
  group_by(Month) %>%
  summarise(
    Seasonal_Deviation = mean(CO2 - CO2_Seasonally_Adjusted)
  )

ggplot(monthly_pattern, aes(x = Month, y = Seasonal_Deviation)) +
  geom_line(color = "darkgreen", linewidth = 1.5) +
  geom_point(color = "darkgreen", size = 3) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  geom_ribbon(aes(ymin = 0, ymax = Seasonal_Deviation), alpha = 0.3, fill = "darkgreen") +
  scale_x_continuous(breaks = 1:12, labels = month.abb) +
  labs(title = "Average Seasonal CO2 Cycle",
       x = "Month", y = "CO2 Deviation from Trend (ppm)") +
  theme_minimal()
#+END_SRC

#+RESULTS:
[[file:images/co2_seasonal_pattern.png]]

#+BEGIN_SRC R :session *R* :exports both :results output
seasonal_amplitude <- max(monthly_pattern$Seasonal_Deviation) - 
                     min(monthly_pattern$Seasonal_Deviation)
peak_month <- month.name[which.max(monthly_pattern$Seasonal_Deviation)]
trough_month <- month.name[which.min(monthly_pattern$Seasonal_Deviation)]

cat("\n=== SEASONAL CYCLE ===\n")
cat(sprintf("Amplitude: %.2f ppm\n", seasonal_amplitude))
cat(sprintf("Peak: %s, Trough: %s\n", peak_month, trough_month))
cat("\nMechanism: Northern Hemisphere vegetation activity\n")
cat("• Spring: respiration dominates → CO2 rises\n")
cat("• Summer: photosynthesis dominates → CO2 falls\n")
#+END_SRC

#+RESULTS:
: 
: === SEASONAL CYCLE ===
: Amplitude: 6.43 ppm
: Peak: May, Trough: October
: 
: Mechanism: Northern Hemisphere vegetation activity
: • Spring: respiration dominates → CO2 rises
: • Summer: photosynthesis dominates → CO2 falls

* Growth Rate Analysis

#+BEGIN_SRC R :session *R* :results output graphics file :file images/co2_rate_of_change.png :width 10 :height 6 :units in :res 150 :exports both
co2_data <- co2_data %>%
  arrange(Date) %>%
  mutate(Annual_Change = CO2 - lag(CO2, 12))

ggplot(co2_data %>% filter(!is.na(Annual_Change)), 
       aes(x = Date, y = Annual_Change)) +
  geom_line(color = "coral", linewidth = 0.7, alpha = 0.7) +
  geom_smooth(method = "loess", span = 0.3, 
              color = "darkred", linewidth = 1.2, se = TRUE, alpha = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  labs(title = "Year-over-Year CO2 Change",
       x = "Year", y = "Annual Increase (ppm/year)") +
  theme_minimal()
#+END_SRC

#+RESULTS:
[[file:images/co2_rate_of_change.png]]

#+BEGIN_SRC R :session *R* :exports both :results output
growth_stats <- co2_data %>%
  filter(!is.na(Annual_Change)) %>%
  summarise(
    Mean_Growth = mean(Annual_Change),
    SD_Growth = sd(Annual_Change),
    Recent_Growth = mean(tail(Annual_Change, 12))
  )

cat("\n=== GROWTH RATE ===\n")
cat(sprintf("Average: %.2f ± %.2f ppm/year\n", 
            growth_stats$Mean_Growth, growth_stats$SD_Growth))
cat(sprintf("Recent (last 12 months): %.2f ppm/year\n", growth_stats$Recent_Growth))
cat("\nNote: Growth rate shows upward trend over time\n")
#+END_SRC

#+RESULTS:
: 
: === GROWTH RATE ===
: Average: 1.67 ± 0.90 ppm/year
: Recent (last 12 months): 2.78 ppm/year
: 
: Note: Growth rate shows upward trend over time

** Decade Comparison

#+BEGIN_SRC R :session *R* :exports both :results output
options(crayon.enabled = FALSE)
decade_analysis <- co2_data %>%
  mutate(Decade = paste0(floor(Year / 10) * 10, "s")) %>%
  group_by(Decade) %>%
  summarise(
    Start_CO2 = first(CO2),
    End_CO2 = last(CO2),
    N_Years = n() / 12,
    Annual_Rate = (End_CO2 - Start_CO2) / N_Years,
    .groups = 'drop'
  ) %>%
  filter(N_Years >= 9)

cat("\n=== DECADE-BY-DECADE ===\n")
print(decade_analysis[, c("Decade", "Annual_Rate")], n = Inf)
#+END_SRC

#+RESULTS:
#+begin_example

=== DECADE-BY-DECADE ===
# A tibble: 6 × 2
  Decade Annual_Rate
  <chr>        <dbl>
1 1960s        0.788
2 1970s        1.17 
3 1980s        1.43 
4 1990s        1.45 
5 2000s        1.84 
6 2010s        2.33
#+end_example

#+BEGIN_SRC R :session *R* :results output graphics file :file images/co2_decade_comparison.png :width 10 :height 6 :units in :res 150 :exports both
ggplot(decade_analysis, aes(x = Decade, y = Annual_Rate, fill = Decade)) +
  geom_col(show.legend = FALSE, alpha = 0.8) +
  geom_text(aes(label = sprintf("%.2f", Annual_Rate)), vjust = -0.5, size = 4) +
  scale_fill_viridis_d(option = "turbo") +
  labs(title = "CO2 Growth Rate by Decade",
       x = "Decade", y = "Annual Increase (ppm/year)") +
  theme_minimal()
#+END_SRC

#+RESULTS:
[[file:images/co2_decade_comparison.png]]

* Future Projections with Uncertainty

#+BEGIN_SRC R :session *R* :results output graphics file :file images/co2_projection_ci.png :width 10 :height 6 :units in :res 150 :exports both
# Prepare projection with 95% CI
current_year <- 2025
projection_years <- seq(current_year, 2050, by = 0.5)
pred_data <- data.frame(Time_Numeric = projection_years - 1958)
predictions <- predict(model_full, newdata = pred_data, 
                      interval = "confidence", level = 0.95)

projection_df <- data.frame(
  Year = projection_years,
  Fit = predictions[, "fit"],
  Lower = predictions[, "lwr"],
  Upper = predictions[, "upr"]
)

historical_df <- data.frame(
  Year = co2_data$Year + (co2_data$Month - 1) / 12,
  CO2 = co2_data$CO2
) %>% filter(Year >= 2000)

# Plot
ggplot() +
  geom_line(data = historical_df, aes(x = Year, y = CO2), 
            color = "darkblue", linewidth = 1) +
  geom_line(data = projection_df, aes(x = Year, y = Fit), 
            color = "orange", linewidth = 1.2, linetype = "dashed") +
  geom_ribbon(data = projection_df, aes(x = Year, ymin = Lower, ymax = Upper), 
              alpha = 0.25, fill = "orange") +
  geom_vline(xintercept = current_year, linetype = "dotted", color = "gray50") +
  annotate("text", x = current_year - 1, y = 480, label = "Present", 
           angle = 90, size = 3, color = "gray40") +
  labs(title = "CO2 Projection to 2050 with 95% Confidence Interval",
       x = "Year", y = "CO2 (ppm)",
       caption = "Shaded area = 95% CI; assumes trend continuation") +
  theme_minimal()
#+END_SRC

#+RESULTS:
[[file:images/co2_projection_ci.png]]

#+BEGIN_SRC R :session *R* :exports both :results output
proj_2030 <- projection_df %>% filter(Year == 2030)
proj_2040 <- projection_df %>% filter(Year == 2040)  
proj_2050 <- projection_df %>% filter(Year == 2050)

cat("\n=== PROJECTIONS [95% CI] ===\n")
cat(sprintf("2030: %.1f [%.1f, %.1f] ppm\n", 
            proj_2030$Fit, proj_2030$Lower, proj_2030$Upper))
cat(sprintf("2040: %.1f [%.1f, %.1f] ppm\n", 
            proj_2040$Fit, proj_2040$Lower, proj_2040$Upper))
cat(sprintf("2050: %.1f [%.1f, %.1f] ppm\n", 
            proj_2050$Fit, proj_2050$Lower, proj_2050$Upper))
cat("\nNote: Confidence interval widens with time.\n")
cat("Actual trajectory depends on future emissions policies.\n")
#+END_SRC

#+RESULTS:
: 
: === PROJECTIONS [95% CI] ===
: 2030: 423.6 [422.8, 424.4] ppm
: 2040: 440.2 [439.2, 441.1] ppm
: 2050: 456.7 [455.6, 457.9] ppm
: 
: Note: Confidence interval widens with time.
: Actual trajectory depends on future emissions policies.

* Statistical Limitations

#+BEGIN_SRC R :session *R* :exports both :results output
cat("\n=== KEY LIMITATIONS ===\n")
cat("• Observational data: correlation ≠ causation\n")
cat("• Time series autocorrelation: standard errors underestimated\n")
cat("• Linear approximation: some acceleration exists\n")
cat("• Extrapolation assumes constant trend (no policy changes)\n")
#+END_SRC

#+RESULTS:
: 
: === KEY LIMITATIONS ===
: • Observational data: correlation ≠ causation
: • Time series autocorrelation: standard errors underestimated
: • Linear approximation: some acceleration exists
: • Extrapolation assumes constant trend (no policy changes)

* Summary

#+BEGIN_SRC R :session *R* :exports both :results output
total_years <- as.numeric(difftime(max(co2_data$Date), min(co2_data$Date), units = "days")) / 365.25

cat("\n=== KEY FINDINGS ===\n")
cat(sprintf("Period: %.1f years (1958-2025)\n", total_years))
cat(sprintf("CO2 increase: %.1f ppm (%.1f%%)\n", 
            last_co2 - first_co2, ((last_co2 - first_co2) / first_co2) * 100))
cat(sprintf("Trend: %.3f [%.3f, %.3f] ppm/year (95%% CI)\n", 
            slope, ci_slope[1], ci_slope[2]))
cat(sprintf("R²: %.4f\n", r_squared))
cat(sprintf("Seasonal amplitude: %.1f ppm\n", seasonal_amplitude))
#+END_SRC

#+RESULTS:
: 
: === KEY FINDINGS ===
: Period: 67.7 years (1958-2025)
: CO2 increase: 110.2 ppm (34.9%)
: Trend: 1.657 [1.639, 1.675] ppm/year (95% CI)
: R²: 0.9751
: Seasonal amplitude: 6.4 ppm

* References

1. *Data Source*: Scripps CO2 Program, Scripps Institution of Oceanography
   - http://scrippsco2.ucsd.edu

2. *Key Papers*:
   - Keeling, C. D., et al. (2001). SIO Reference Series, No. 01-06.
   - Keeling, C. D., et al. (2005). In: A History of Atmospheric CO2, Springer.

* Technical Notes

- *Tool*: R with Tidyverse, ggplot2
- *Methods*: Linear regression, confidence intervals, exploratory data analysis
- *Reproducibility*: All code provided; missing values (-99.99) filtered
